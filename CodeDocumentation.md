# Техническое описание проекта
## **Стек: Python 3.11, SQLAclemy Core, SQLAclhemy ORM, PostgreSQL.**
----
## 1. Общее:
Перед запуском необходимо запустить скрипт basedata/create_bd.py для создания таблиц в PostgreSQL

Для полноценной работы бота должны быть запущены два скрипта:
1) **Скрипт main.py** - основной интерфейс бота;
2) **Скрипт notifications.py** - для отправки уведомления пользователя. Если данный скрипт запущен не будет, то основной функционал бота всё так же будет доступен, однако уведомления пользователям отправляться не будут.
   
**--Директория forprogramm** - пустая папка, удалять её нельзя. Это вспомогательная папка для отправка пользовательских слов им на Яндекс Диск;

**--Директория basedata** - для работы с Базой данных;

**-- Директория scripts** - основные функции для работы телеграм бота;

**-- Файл requirements** - файл с зависимостями проекта.


### _2. Файл info.json (директория basedata):_
Перед началом работы бота нужно вставить в данный файл необходимые данные о Базе данных PostgreSQL и токен от бота Телеграмма.

![image](https://github.com/user-attachments/assets/aed57a28-8d5e-43e3-9020-910693be9e4e)


### _3. Файл main.py:_
В данном файле представлены три основные функции:

_Функции скрипта:_

**-3.1. Функция start_bot** - обрабатывает единственную команду /start - запускает Inline клавиатуру с главным меню бота;

**-3.2. Функция callback_inline_start** - обрабатывает callback_data сообщения, которые поступают боту при нажатии на Inline клавиши. В данной функции описаны все такие;

**-3.3. Функция another_message** - обрабатывает сообщения пользователя.

При первичном вызове пользователем команды start происходит его инициализация. Данные о нём записываются в таблицу Users.


### _4. Файл notifications.py:_
Данный скрипт предназначен для  отправки уведомлений:

_Функции скрипта:_

**-4.1. Функция time_notif** - определяет пользователей, у которых включены уведомления и за счет цикла while отправляет им уведомления в чат.


### _5. Папка BaseData - Файл words.txt:_
Текстовый файл с 2000 английских слов и их переводом (при первом запуске бота они заносятся в БД).


### _6. Папка BaseData - Файл models.py:_
Данный скрипт предназначен для создания таблиц в базе данных. 

Все таблицы имеют связь друг к другу, в основном 1 к 1 или 1 ко многим. Таблица Users и AllWords имеют связь многие ко многим, на основе этого создаются таблицы UserWord и FavoriteWordUser

В скрипте имеются следующие модели таблиц:
- Таблица Users: предназначена для хранения основной информации о пользователе содержит в себе tg id пользователя, его tg-имя, пользовательское имя и яндекс-токен (по умолчанию он пустой);
- Таблица AllWords: предназначена для хранения базы слов содержит в себе английское слово, перевод английского слова на русском, транскрипцию;
- Таблица UserWord: предназначена для хранения словаря пользователя. Включает в себя поля id слова (из AllWords), id tg пользователя (из Users), слово на английском, перевод английского слова на русском;
- Таблица FavoriteWordUser: таблица идентичная таблице UserWord, предназначена для хранения избранных слов пользователей;
- Таблица TranslatorWord: предназначена для хранения языка перевода слов в чате, содержит в себе id tg пользователя (из Users) и перевод (en-ru или ru-en);
- Таблица WinRateWord: предназначена для хранения правильных неправильных ответов пользователей при переводе слов, содержит в себе id tg пользователей (из Users) и answer - ответ (true / false);
- Таблица Notifications: предназначена для хранения информации об уведомлении пользователей, содержит в себе id tg пользователей (из Users) и время отправки уведомления;
- Таблица ActionsUsers: предназначена для сохранения последнего действия пользователя, содержит в себе id tf пользователей (из Users) и наименование действия;
- Таблицы RepeatWord и RepeatWords: предназначены для временного сохранения изучемых/повторяемых слов, помогают программе в работе, содержат в себе id tg пользователя, id слова, английское слово и его перевод + 3 случаных слова на русском.

  Данные таблицы (модели) представлены в виде классов при помощи библиотеки sqlalchemy (ORM).

**Схема Базы данных представлена ниже:**

![image](https://github.com/user-attachments/assets/b1c5c24a-1a28-4425-9e16-66f9dbd62c2c)


### _7. Папка BaseData - Файл create_bd.py:_
Скрипт предназначен для создании Базы Данных

_Функции скрипта:_

**-7.1. Функция get_info(info_puth)** - принимает в себя путь к файлу с информацией о БД и возвращает информацию о базе данных (логин, пароль и .д.);

**-7.2. Функция check_bd(puth)** - принимает в себя информацию о Базы Данных, проверяет, существуют ли таблицы в БД. Принимает путь к Базе Данных - path параметр. Если хоть 1 таблица с именем созданных моделей будет сущестсвовать, то выдаст ошибку, в ином случае вернёт True

**-7.3. Функция create_bd(info_puth)** - принимает в себя путь к файлу с информацией о Базе Данных и создает БД в PostgreSQL;

**-7.4. Функция loads_words(info_puth, name_file)** - принимает в себя путь к файлу с информацией о БД и имя файла со списком слов. Загружает слова и Базу данных в таблицу AllWords.


### _8. Папка Scripts - Файл add_words_yandex.py:_
Скрипт предназначнен для работы с Яндекс диском.

_Функции скрипта:_

**-8.1. Функция save_words(user_id, bd)** - сохраняет необходимые слова для отправки в файл. Принимает в себя user_id - id tg пользователя, bd - название базы данных, из которых брать слова для загрузки (UserWord или FavoriteWordUser). Возвращает False, если загружать нечего, True - если загрузка удалась;

**-8.2. Функция create_folder_yandex(token, folder)** - создает папку на Яндекс Диске. Принимает token - токен Яндекс Диска, folder - Название папки на яндекс диске. Возвращает статус код ответа;

**-8.3. Функция put_yandex_data(yandex_token, user_id, bd)** - отправляет загруженный функцией save_words файл на яндекс диск. Принимает в себя yandex_token - токен Яндекс Диска, user_id - id tg пользователя, bd - название базы данных (UserWord или FavoriteWordUser). Возвращает кортеж с сообщением об успехе загрузки и числом 0 или 1;

**-8.4. Функция check_connect_to_yandex_disk(yandex_token)** - проверяет полученный от пользователя токен на корректность. Принимает в себя yandex_token - токен Яндекс Диска. Возвращает статус get запроса к Яндекс Диску.


### _9. Папка Scripts - Файл bd_func.py:_
Скрипт предназначнен для работы с Базой Данной. Отправляет различные запросы. Функции представлены в класса, которые наследуются от класса Session, который содержит подключение к Базе данных. В каждой функции первым аргументом идет аргумент self - ссылка на данный экземпляр класса.

_Содержание классов скрипта:_

9.1. Класс Session - общий класс для подключения к Базе Данных:

1) **Магический метод __init__(self, path)** - для инициализации подключения к Базе Данных через SQLAclhemy ORM.

9.2. Класс TableUsers - для работы с таблице Users:

1) **Метод info_user(self, id_user)** - для получения информации о пользователе (id tg, имени, имени в tg, яндекс токена). Возвращает список полученных данные. Принимает в себя id tg пользователя;

2) **Метод add_user(self, id, first_name, last_name)** - при первичном вызове команды /start идет вызов данной функции и за счет неё происходит добавление id, языка переводчки (none), уведомлений (none), действия (none) пользователя в Базу Данных. Функция принимает в себя: id- id tg пользователя, first_name - имя пользователя, last_name - пользовательское имя;

3) **Метод add_token(self, id_user, token)** - добавляет токен Яндекс Диска пользователю в БД. Принимает в себя id_user - id tg пользователя, token - токен от Яндекс Диска.

9.3. Класс TableAllWords - для работы с таблицей общих слов:

1) **Метод random_words(self, count)** - извлекает случайные слова из Базы Данных - таблицы AllWords. Метод вернет список случайных слов из БД. Принимает в себя count - количество извлеченных слов.

9.4. Класс TableUserWords - для работы с добавленными пользователями словами:

1) **Метод user_words(self, id_user, tab, randoms, count=100*100)** - извлекает пользовательские слова из Базы Данных. Метод вернет список пользовательских слов из Базы Данных. Принимает в себя: id_user - id tg пользователя, tab - таблица (Фактически принимает в себя любое слово, если слово содержит нижний пробел, значит будет выбрана таблица FavoriteWordUser, в ином случае - UserWord), randoms - если True, значит извлекаются случаные слова, False - не случайны, count - количество извлекамыех слов, по умолчанию 10000 слов. Метод;

2) **Метод user_count_words(self, id_user, tab)** - получение информации о количестве слов. Функция возвращает количество слов в Базе данных пользователя (UserWord или FavoriteWordUser). Принимает в себя: id_user - id tg пользователя , tab - dict или favorite;

3) **Метод add_word_user(self, id_word, id_user, tab)** - добавляет слова пользователю в словарь или в избранное.Функция вернёт True, если слово добавится, False - если слово уже добавлено. Принимает в себя: id_word - id слова (из таблицы AllWords), id_user - id tg пользователя, tab - таблица, куда будет загружаться слово (add dict - в таблицу UserWord, add favorite - в таблицу FavoriteWordUser);

4) **Метод delete_word(self, id_user, tab, count)** - удаляет слова из словаря или избранного. Принимает в себя:id_user - id tg пользователя, tab - таблица, из которой будут удаляться слова (dict - таблица UserWord, favorite - таблица FavoriteWordUser), count - количество удаляемых слов: one - одно слово, all - все слова;

9.5. Класс TableTranslator - для работы таблицы переводчкика:

1) **Метод info_user_language(self, id_user)** - получение информации о установленном пользователе языке. Возвращает список из одного элемента - установленный пользователем язык. Принимает в себя id tg пользователя;

2) **Метод add_language(self, id_user, language)** - для добавления или обновления языка перевода пользователя. Принимает в себя id_user - id tg пользователя, language - язык.

9.6. Класс TableStatistics - для работы со статистикой переведённых слов пользователей:

1) **Метод add_result_selection(self, id_user, result)** - функция сохраняет результат выбора ответа пользователя при переводе слов: верно - неверно. Принимает в себя: id tg пользователя, result - true или false;

2) **Метод show_result_user(self, id_user)** - функция выводит правильные и неправильные ответы пользователя. Возвращает процент правильных ответов (например, 24.31). Принимает в себя id tg пользователя.

9.7. Класс TableNotification - для работы с таблицей уведомлений пользователей:

1) **Метод notif_users(self, id_user=None, all_users=True)** - получает информации об уведомлениях пользователей. Возвращает список кортежей, состоящих из id tg пользователей и их уведомлений. Принимает в себя: id_user (по умолчанию None) - tg id пользователя, all_users (по умолчанию True) - если True, значит вернёт информацию об уведомлениях всех пользователей, False - об одном пользователе. Если all_users=False, то обязательно должен быть прописан id_user, чтобы найти его в таблице Notifications;

2) **Метод update_notif(self, id_user, notif)** - устанавливает или отключает уведомления пользователю. Принимает в себя id_user - id tg пользователя, notif - информация об времени отправки уведомления (например, 12:00).

9.8. Класс TableRepeatWord - для работы с таблицей изучаемыми слов пользователя:

1) **Метод get_repeat_words(self, id_user)** - метод для получения ВСЕХ угадываемых слов и их перевода, принимает в себя id_user - id tg пользователя и возвращает спиосок кортежей из id слова, id tg пользователя, слова на английском и его переводе + 3 случайных слова на русском;

2) **Метод save_repeat_word(self, id_word, id_user, eng_word, ru_word, word1, word2, word3, word4)** - метод для записи угадываемого слова, принимает id слова, id tg пользователя, слово на английском и его перевод + 3 случайных слова на русском;

3) **Метод delete_repeat_word(self, id_user)** - метод для удаления слова для повторения.

9.8. Класс TableRepeatWords - для работы с таблицей изучаемыми слов пользователя:

1) **Метод get_repeat_words(self, id_user)** - Функция для получения ОДНОГО угадываемого слова и общее количество слов пользователя в RepetWords, принимает в себя id_user - id tg пользователя;

2) **Метод save_repeat_words(self, words: list[tuple])** - метод для записи ВСЕХ угадываемых слов. Функция принимает список кортежей, где каждый кортеж содержит в себе id слова, id_tg пользователе, слово на английском и его перевод на русском. Функция записывает слова в таблицу RepeatWord: первые 4 аргумента - элементы текущего кортежа, вторые 4 аргумента - 3 случайных слов на русском из других полученных кортежей и 1 слово на русском из текущего кортежа. Принимает в себя список кортежей, состоящих из id tg пользователя, id слова, слова на английском и его переводе + 3 случайных слова на русском.

3) **Метод delete_repeat_words(self, id_user, id_word=None)** - метод для удаления записанных слов для повторения, если id_word не указан, то удаляются все слова, если указан - одно слово, id_word - id слова, id_user - id tg пользователя.

9.8. Класс TableAction - для работы с таблицей текущих действий пользователей:

1) **Метод save_action(self, id_user, action)** - для сохранения действия, принимает в себя id_user - id tg пользователя и action - действие, которое надо сохранить;

2) **Метод get_user_action(self, id_user)** - для получения действия пользователя, принимает в себя id_user - id tg пользователя. Метод возвращает последнее действие в боте пользователя.



**Метод update_notif(self, id_user, notif)** - устанавливает или отключает уведомления пользователю. Принимает в себя id_user - id tg пользователя, notif - информация об времени отправки уведомления (например, 12:00).


### _10. Папка Scripts - Файл func_sc.py:_
Данный скрипт является основным и позволяет управлять интерфейсом ботом. В большинстве его функциях находятся схожие аргументы:

bot - экземпляр класса бота, который подключается в скрипте main.py и notifications.py;

chat_id - id tg пользователя;

id_mess - id сообщения в чате с ботом;

cb_dat - ответ, поступающий после нажатия на Inline клавишу в чате с ботом;

call_id - id callback ответа бота.


_Функции скрипта:_

**-10.1. Функция inline_main_menu(chat_id, bot, show='send', id_mess=None)** - для Inline клавиатуры главного меню бота. Если show='send', значит клавиатура отправляется новым сообщеним, show='replace' - текущая клавиатура заменяется на клавиатуру с главным меню;

**-10.2. Функция inline_learn_all_words(id_user, bot, id_mess, repeat=False)** - для Inline клавиатуры изучения слов. Если repeat = False, то слова берутся из общей Базы Данных слов - AllWords, если true - слова берутся для повторога из пользовательского списка (UserWord или FavoriteWordUser);

**-10.3. Функция inline_add_words(id_user, bot, id_mess)** - для Inline клавиатуры добавленных слов, где пользователю предлагается выбрать свой список слов - Словарь или Избранное, а также загрузить слова на Яндекс диск;

**-10.4. Функция inline_learn_user_words(id_user, id_mess, bot, cb_dat)** - для Inline кдавиатуры просмотра меню словаря или избранных слов. В меню пользователю предлагается повторить добавленные в слова или вывести из список в алфавитном порядке или по последним добавленым. Так же есть возможность очистить словарь или список избранных слов;

**-10.5. Функция user_dict_count(id_user, id_mess, bot, cb_dat)** - Inline клавиатуры выбора количества слов (для повторения или вывода слов из слова / списка избранного). Пользователю предлагается выбрать 10, 20, 30, 50 слов или все слова;

**-10.6. Функция inline_save(bot, id_user, id_mess)** - для Inline клавиатуры выбора сохранения слов на яндекс диск;

**-10.7. Функция inline_translator_menu(bot, id_user, id_mess)** - для меню выбора перевода слов в чате. Пользователю предлагается выбрать язык перевода слов в чате - с английского на русский и наоборот;

**-10.8. Функция inline_notifications(bot, id_user, id_mess)** - для Inline клавиатуры по установке уведомлений. Пользователю предлагается установить уведомления на 00:00, 12:00, 15:00, 18:00, 20:00, 22:00 часа или отключить уведомления;

**-10.9. Функция notifications(id_user, bot, cb_dat, call_id)** - включает или выключает уведомления пользователя, которые устанавливаются в меню уведомлений;

**-10.10. Функция user_words_repeat_or_print(id_user, id_mess, bot, cb_dat, cb_id)** - вызов меню повторения или вывод пользовательских слов

**-10.11. Функция delete_user_word(id_user, bot, id_mess, cb_dat, call_id)** - для удаления слов пользователя, удаляет все слова, если ответ (callback_data) с Inline клавиатуры равен 'del_f' или 'del_du' или удаляет одно слово, если ответ 'del_favorit word' или 'del_dict word';

**-10.12. Функция add_yandex_token(bot, text, id_user)** - для подключения яндекс токена. Принимает в себя text - яндекс токен, полученный от пользователя в чате. Программа обрабатывает сообщения пользователя в чате, и если сообщение соответствует формату token: <буквы>, то функция перехватывает это сообщение;

**-10.13. Функция send_yand_disk(id_user, bot, id_mess, cb_dat, cb_id)** - для сохранения слов на Яндекс диск;

**-10.14. Функция translate_installation(bot, id_user, cb_dat)** - для оповещения и установки языка перевода. Функция записывает в таблицу Базы Данных язык перевода слов пользователя;

**-10.15. Функция translate_chat_word(bot, id_user, text)** - для перевода слов в чате. Бот принимает от пользователя сообщения и отправляет их в данную функция, которая за счет функции info_user_language(id_user) переводит слова на русский или английский;

**-10.16. Функция info_user(bot, id_user, id_mess)** - выводит полную информацию о пользователе в текстовым сообщением в чат: имя, пользовательское имя tg, tg id пользователя, количество слов в словаре, количество слов в избранном, язык перевода слов в чате, процент правильно выбранных слов, информацию о уведомлениях пользователя;

**-10.17. Функция check_word_learn(id_user, bot, cb_dat, cb_id)** - проверяет, правильно ли пользователь перевёл слово и сообщает об этом всплывающим сообщением в чате;

**-10.18. Функция empty_response(bot, call_id)** - для пустых Inline клавиш. Некоторые клавиши в меню бота исключительно декоративные и не несут в себе никакой смысловой нагрузки. При нажатии над данные клавиши, бот отправляет всплывающее сообщение '👀 Тут ничего нет 👀';

**-10.19. Функция add_word_to_user(id_user, cb_dat, cb_id, bot)** - для добавления слов в избранное или словарь в момент, когда пользователь изучает слова;

**-10.20. Функция choose_plural(amount, declensions, dop='')** - вспомогательная функция для склонения слов, где amount - количество (число), declensions - склонения (кто, кого, сколько) - кортеж. Например choose_plural(6, ('яблоко', 'яблоко', 'яблок')) - результатом будет 6 яблок;

**-10.21. Функция translate_word(word, language='ru-en')** - для перевода слов. Подключается к яндекс переводчику;
